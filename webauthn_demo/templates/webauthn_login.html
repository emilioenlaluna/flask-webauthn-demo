{% extends 'base.html' %}
{% block title %}Login · Flask WebAuthn{% endblock %}

{% block content %}
<h2>Login with a Security Key</h2>

<form id="form" method="post">
  <input type="hidden" id="credential" name="credential">
</form>
<p class="mt-3">Or go <a href="{{ url_for('main.index') }}">back</a>.</p>
{% endblock %}

{% block modules %}
<script type="module">
  import { get } from "https://cdn.skypack.dev/@github/webauthn-json";
  
  (async () => {
    const options = {{ options|tojson }};
    try {
      // ←——  envolvemos en {publicKey: …}
      const credential = await get({ publicKey: options });
      document.querySelector("#credential").value = JSON.stringify(credential);
      document.querySelector("#form").submit();
    } catch (err) {
      console.error("WebAuthn error", err);
      alert("No se pudo obtener la credencial:\n" + err.message);
    }
  })();
  </script>
  
{% endblock %}
